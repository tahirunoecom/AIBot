version: "3.1"

rules:

- rule: Say goodbye anytime the user says goodbye
  steps:
  - intent: goodbye
  - action: utter_goodbye

- rule: Say 'I am a bot' anytime the user challenges
  steps:
  - intent: bot_challenge
  - action: utter_iamabot

- rule: Handle fallback
  steps:
  - intent: nlu_fallback
  - action: action_custom_fallback

- rule: Show categories on user request
  steps:
  - intent: show_categories
  - action: action_show_categories_with_products

- rule: select product by number
  steps:
  - intent: select_product
  - action: action_select_product

- rule: Add to cart
  steps:
  - intent: add_to_cart
  - action: action_add_to_cart

- rule: Show cart
  steps:
  - intent: view_cart
  - action: action_view_cart

- rule: Show user address before checkout
  steps:
  - intent: get_address
  - action: action_get_address

- rule: Initiate Stripe payment
  steps:
  - intent: pay_now
  - action: action_create_stripe_checkout

- rule: Check payment status
  steps:
  - intent: check_payment_status
  - action: action_check_payment_status

- rule: Respond to FAQ intent
  steps:
    - intent: faq
    - action: utter_faq

- rule: Show next page of product search
  steps:
    - intent: search_products_next
    - action: action_next_product_page  # increments slot
    - action: action_product_llm_search # reruns the search

- rule: Reset page on new product search
  steps:
    - intent: search_products
    - action: action_reset_search_page
    - action: action_product_llm_search

# Handle store searches by directly invoking the nearest-store action.  The action
# will prompt for a ZIP code if none is available.
- rule: Search for nearest store
  steps:
  - intent: search_store
  - action: action_get_nearest_store

# When the user provides a ZIP code (provide_zipcode intent), call the nearest-store action
- rule: Provide ZIP code and get nearest store
  steps:
  - intent: provide_zipcode
  - action: action_get_nearest_store

- rule: Ask for store selection if multiple stores found
  steps:
  - action: action_show_store_options 

- rule: Set selected store and update context
  steps:
  - intent: select_store
  - action: action_set_selected_store

# If the user wants to change the ZIP code, clear the existing value and prompt for a new one.
- rule: Handle user wanting to change ZIP code mid-conversation
  steps:
  - intent: change_zipcode
  - action: action_change_zipcode

- rule: Handle user wanting to change store mid-conversation
  steps:
  - intent: change_store
  - action: action_get_nearest_store

# Provide registration link when the user asks to register
- rule: Provide registration link
  steps:
  - intent: register
  - action: utter_register_link



# Respond to greetings
- rule: Respond to greeting
  steps:
  - intent: greet
  - action: action_custom_greet
  
  
# --- LOGIN FLOW ---
- rule: Start login
  steps:
    - intent: login
    - action: action_login_user

- rule: Continue login - awaiting phone
  condition:
    - slot_was_set:
        - login_step: awaiting_phone
  steps:
    - intent: inform
    - action: action_login_user

- rule: Continue login - awaiting password
  condition:
    - slot_was_set:
        - login_step: awaiting_password
  steps:
    - intent: provide_password
    - action: action_login_user

# Handle user providing their user ID after being prompted to log in
- rule: Handle user ID for login
  steps:
  - intent: provide_user_id
  - action: action_login_user